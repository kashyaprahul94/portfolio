pipelines:
  - name: portfolio_app
    configuration:
      environmentVariables:
        readOnly:
          GIT_BRANCH: "{{gitBranch}}"
          DOCKER_REGISTRY: "kashyaprahul94-docker.jfrog.io"
          DOCKER_IMAGE_NAME: "portfolio-app"

    steps:
      - name: app_entry
        type: Bash
        configuration:
          inputResources:
            - name: repoApp
        execution:
          onStart:
            - printenv
            - pushd $res_repoApp_resourcePath
            - add_run_variables RELEASE_TAG=$( ./pipelines/normalize-version.sh ${GIT_BRANCH} )
            - echo "Release tag is --> ${RELEASE_TAG}"
            - popd

      - name: app_docker_build
        type: DockerBuild
        configuration:
          integrations:
            - name: kashyaprahul94_artifactory
          inputResources:
            - name: repoApp
          inputSteps:
            - name: app_entry
          affinityGroup: group_docker_build_push

          dockerFileLocation: packages/app
          dockerFileName: Dockerfile
          dockerImageName: "${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}"
          dockerImageTag: ${RELEASE_TAG}
        execution:
          onSuccess:
            - echo "Docker image was built with '$RELEASE_TAG' tag"

      - name: app_docker_push_to_jfrog
        type: DockerPush
        configuration:
          integrations:
            - name: kashyaprahul94_artifactory
          inputSteps:
            - name: app_docker_build
          affinityGroup: group_docker_build_push

          targetRepository: docker
        execution:
          onStart:
            - docker images
          onSuccess:
            - echo "Docker image is pushed to JFrog Docker Registry --> ${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:${RELEASE_TAG}"